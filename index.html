<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diff Analyzer</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            /* max-width: 1400px;
            margin: 0 auto; */
            padding: 20px;
        }
        .diff-content {
            width: 100%;
            height: 300px;
            font-family: monospace;
            margin-bottom: 20px;
            padding: 10px;
        }
        .prompt {
            width: 100%;
            height: 100px;
            margin-bottom: 20px;
            padding: 10px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
        }
        .loading {
            display: none;
            color: #666;
            margin: 10px 0;
        }
        .error {
            color: red;
            margin: 10px 0;
            display: none;
        }
        .mode-toggle {
            margin: 20px 0;
            padding: 10px;
            background: #f5f5f5;
            border-radius: 4px;
        }
        .mode-description {
            margin-top: 5px;
            color: #666;
            font-size: 0.9em;
        }
        
        /* New side-by-side styles */
        .side-by-side {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .code-panel {
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #f8f8f8;
        }
        .analysis-panel {
            border: 1px solid #ccc;
            border-radius: 4px;
            background: #fff;
            padding: 20px;
        }
        .file-header {
            padding: 10px;
            background: #2d333b;
            color: #fff;
            font-family: monospace;
            font-size: 14px;
            border-top-left-radius: 4px;
            border-top-right-radius: 4px;
        }
        .code-section {
            padding: 10px;
            overflow-x: auto;
        }
        .code-line {
            display: flex;
            font-family: monospace;
            font-size: 14px;
            line-height: 1.5;
            white-space: pre;
            padding: 2px 4px;
        }
        .code-line-content {
            margin-left: 10px;
        }
        .line-addition {
            background: #e6ffed;
            color: #000;
        }
        .line-deletion {
            background: #ffeef0;
            color: #000;
        }
        .line-neutral {
            color: #999;
        }
        .analysis-content {
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.6;
            color: #333;
        }
        .analysis-section {
            margin-bottom: 20px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>Diff Analyzer</h1>
    
    <div class="mode-toggle">
        <label style="display: flex; align-items: center; gap: 8px;">
            <input type="checkbox" id="accessibilityMode" onchange="toggleMode()">
            <span>Accessibility Analysis Mode</span>
        </label>
        <div id="modeDescription" class="mode-description">
            Regular analysis mode. Toggle for accessibility-focused review.
        </div>
    </div>

    <div>
        <label for="diffContent">Paste your diffs here:</label><br>
        <textarea id="diffContent" class="diff-content" placeholder="Paste one or more diffs here...
Example:
diff --git a/src/Button.js b/src/Button.js
--- a/src/Button.js
+++ b/src/Button.js
@@ -1,3 +1,3 @@
-<div onClick={click}>Button</div>
+<button onClick={click}>Button</button>"></textarea>
    </div>
    
    <div>
        <label for="prompt">Your question or prompt:</label><br>
        <textarea id="prompt" class="prompt" placeholder="What would you like to know about these changes?"></textarea>
    </div>
    
    <button onclick="analyzeDiffs()">Analyze Diffs</button>
    
    <div id="loading" class="loading">Analyzing...</div>
    <div id="error" class="error"></div>
    <div id="results" class="side-by-side"></div>

    <div style="margin-top: 20px;">
        <details>
            <summary style="cursor: pointer; padding: 10px; background: #f5f5f5; border-radius: 4px;">
                Debug Logs
            </summary>
            <div id="debugLog" style="
                margin-top: 10px;
                padding: 10px;
                background: #f8f8f8;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-family: monospace;
                font-size: 12px;
                max-height: 300px;
                overflow-y: auto;
            "></div>
        </details>
    </div>

    <script>
        function log(message, data) {
            const timestamp = new Date().toISOString();
            console.log(`[${timestamp}] ${message}`, data || '');
            
            const debugLog = document.getElementById('debugLog');
            if (debugLog) {
                const logLine = document.createElement('div');
                logLine.textContent = `${timestamp} ${message} ${data ? JSON.stringify(data) : ''}`;
                debugLog.prepend(logLine);
                
                while (debugLog.children.length > 50) {
                    debugLog.removeChild(debugLog.lastChild);
                }
            }
        }

        function parseDiffs(diffText) {
            const diffs = diffText.split(/(?=diff --git)/);
            
            return diffs
                .map(diff => {
                    if (!diff.trim()) return null;
                    
                    const fileMatch = diff.match(/diff --git a\/(.*?) b\//);
                    if (!fileMatch) return null;
                    
                    return {
                        filename: fileMatch[1],
                        content: diff.trim()
                    };
                })
                .filter(Boolean);
        }

        function toggleMode() {
            const checkbox = document.getElementById('accessibilityMode');
            const description = document.getElementById('modeDescription');
            const promptArea = document.getElementById('prompt');
            
            if (checkbox.checked) {
                description.textContent = 'Accessibility analysis mode: Reviewing changes for ARIA attributes, semantic HTML, keyboard navigation, and screen reader compatibility.';
                promptArea.placeholder = 'Add any specific accessibility concerns or questions...';
            } else {
                description.textContent = 'Regular analysis mode. Toggle for accessibility-focused review.';
                promptArea.placeholder = 'What would you like to know about these changes?';
            }
        }

        function analyzeDiffs() {
            log('Starting diff analysis');
            const diffText = document.getElementById('diffContent').value;
            log('Raw diff text length:', diffText.length);
            
            const patches = parseDiffs(diffText);
            log('Parsed patches:', patches.map(p => ({
                filename: p.filename,
                contentLength: p.content.length
            })));
            
            if (!patches.length) {
                const error = 'No valid diffs found. Please check the format.';
                log('Error:', error);
                document.getElementById('error').textContent = error;
                document.getElementById('error').style.display = 'block';
                return;
            }

            const prompt = document.getElementById('prompt').value;
            const isAccessibilityMode = document.getElementById('accessibilityMode').checked;
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';

            const endpoint = isAccessibilityMode ? 
                'http://localhost:3000/analyze-patches/accessibility' : 
                'http://localhost:3000/analyze-patches';

            log('Making request to endpoint:', endpoint);
            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ patches, prompt })
            })
            .then(response => {
                log('Received response with status:', response.status);
                return response.json();
            })
            .then(data => {
                log('Received data:', {
                    success: data.success,
                    responseLines: data.response?.length,
                    error: data.error
                });
                if (data.success) {
                    displaySideBySide(patches, data.response);
                } else {
                    throw new Error(data.error || 'Failed to analyze diffs');
                }
            })
            .catch(error => {
                document.getElementById('error').textContent = error.message;
                document.getElementById('error').style.display = 'block';
            })
            .finally(() => {
                document.getElementById('loading').style.display = 'none';
            });
        }

        function displaySideBySide(patches, analysis) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            
            // Create main panels
            const codePanel = document.createElement('div');
            codePanel.className = 'code-panel';
            
            const analysisPanel = document.createElement('div');
            analysisPanel.className = 'analysis-panel';
            
            patches.forEach(patch => {
                // Add file header
                const fileHeader = document.createElement('div');
                fileHeader.className = 'file-header';
                fileHeader.textContent = patch.filename;
                codePanel.appendChild(fileHeader);
                
                const codeSection = document.createElement('div');
                codeSection.className = 'code-section';
                
                // Split patch into lines
                const lines = patch.content.split('\n');
                let lineNo = 1;
                lines.forEach(line => {
                    const codeLine = document.createElement('div');
                    codeLine.className = 'code-line';
                    
                    if (line.startsWith('+')) {
                        codeLine.className += ' line-addition';
                    } else if (line.startsWith('-')) {
                        codeLine.className += ' line-deletion';
                    } else {
                        codeLine.className += ' line-neutral';
                    }
                    
                    const lineNumber = document.createElement('span');
                    lineNumber.className = 'line-number';
                    lineNumber.textContent = lineNo++;
                    
                    const lineContent = document.createElement('span');
                    lineContent.className = 'code-line-content';
                    lineContent.textContent = line;
                    
                    codeLine.appendChild(lineNumber);
                    codeLine.appendChild(lineContent);
                    codeSection.appendChild(codeLine);
                });
                
                codePanel.appendChild(codeSection);
            });
            
            // Add full analysis response
            const analysisContent = document.createElement('div');
            analysisContent.className = 'analysis-content';
            const analysisText = analysis.map(line => line.content).join('\n');
            
            // Split analysis into sections based on double newlines
            const sections = analysisText.split('\n\n');
            sections.forEach(section => {
                if (section.trim()) {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'analysis-section';
                    sectionDiv.textContent = section;
                    analysisPanel.appendChild(sectionDiv);
                }
            });
            
            // Add both panels to the results
            resultsDiv.appendChild(codePanel);
            resultsDiv.appendChild(analysisPanel);
        }
        
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>
</html>